# 20 - 闭包

## 是什么

闭包就是一个绑定了执行环境的函数，它利用了词法作用域的特性，在函数嵌套时，内层函数引用外层函数作用域下的变量，并且内层函数在全局环境下可访问，就形成了闭包

以下为各路大神对闭包的定义：

- winter
  - 闭包其实只是一个绑定了执行环境的函数
  - 闭包与普通函数的区别是，它携带了执行环境，就像人在外星中需要自带吸氧的装备一样，这个函数也带有在程序中生存的环境
  - 实际上 JavaScript 中跟闭包对应的概念就是 “函数”

- 侯策
  - 函数嵌套函数时，内层函数引用了外层函数作用域下的变量，并且内层函数在全局环境下可访问，就形成了闭包

- 黑客与画家
  - 闭包（Lexical Closure）一个函数，通过它可以引用由包含这个函数所定义的变量

- MDN
  - 闭包是指那些能够访问自由变量的函数
    - 自由变量是指在函数中使用的，但既不是函数参数也不是函数局部变量的变量
  - 闭包 = 函数 + 函数能够访问的自由变量

- 现代JavaScript 教程
  - 闭包是指一个函数可以记住其外部变量并可以访问这些变量

- 《你不知道的JavaScript》
  - 闭包是基于词法作用域书写代码时所产生的自然结果，你甚至不需要为了利用它们而有意识地创建闭包
  - 闭包的创建和使用在你的代码中随处可见
  - 你缺少的是根据你自己的意愿来识别、拥抱和影响闭包的思维环境

- 《浏览器工作原理与实践》 By 李兵
  - 在 JavaScript中，根据此法作用域的规则，内部函数总是可以访问其外部函数中声明的变量，当通过调用一个外部函数返回一个内部函数后，即使该外部函数已经执行结束了，但是内部函数引用外部函数的变量依然保存在内存中，我们就把这些变量的集合称为闭包

## 闭包形成的原理

### 关联的知识点

- 词法作用域
  - 这里我们说的都是函数作用域，它由函数被声明时所处的位置决定
  - 函数作用域有个特点
    - 函数内的变量函数外不能访问
    - 函数外的变量函数内能访问
- 词法环境
  - 在代码编译阶段记录变量声明、函数声明、函数声明形参的合集
- 执行上下文与调用栈
  - 调用函数时所带的所有信息
    - 词法环境
    - 变量环境
    - this

> 一段代码在执行时分为两个阶段，编译阶段和执行阶段（JavaScript 时解释性语言，会逐行执行程序，但还是会有两个阶段，两者相差几微妙）
>
> - 编译阶段会发生变量提升，确定作用域，生成词法环境，词法环境包括环境记录器和outer
>   - 环境记录器记录自由变量
>   - outer 指向父作用域
>   - 词法环境的环境记录器收集var、function等变量；变量环境的环境记录器收集let、const、class等变量
> - 执行阶段会创建执行上下文，它包括词法环境、变量环境和this，以及确定作用域链
>
> ---
>
> 也就是说执行上下文除了 this，像词法环境、变量环境在编译阶段就已经确定了，其中词法环境的变量var、function会进行变量、函数提升，并初始化，而变量环境中的变量虽然提升了，但是不会被初始化；而两者的outer 则相同，他们都指向父作用域
>
> 当代码要访问一个变量时，首先会搜索自身的作用域（即内部词法环境）是否有此变量，再沿着outer，去父作用域（外部环境），然后搜索更外部的环境，以此类推，直到全局词法环境，这种关系被称为作用域链，是在函数调用时被确认的

### 闭包示例及分析

```javascript
// 闭包示例 1
function foo(){
    var a = 1;
    var b = 2;
    return function bar(){
        console.log(a++);
    }
}

var baz = foo();
baz();
```

- 在任何代码执行之前，先创建全局执行上下文，并往调用栈中压栈
- 接着创建词法环境，登记函数声明foo 和变量声明baz （此时处于编译阶段）
- 由于全局词法环境没有外部引用，所以outer 指向了null

![刚开始执行](/static/v2-c795595bbe648016bb68a83f216a51e6_r.jpg)

- 代码开始执行，执行foo()


## 闭包的作用

## 闭包的优缺点及误区

## 闭包的应用

### 作为返回值

### 作为参数传递

### 私有实例变量

### 函数式编程

### 面向事件编程

### 模块化

### React hooks

## 总结

## 参考资料

- [深入理解JavaScript——闭包](https://zhuanlan.zhihu.com/p/574913236) [知乎 @Johan 约翰]